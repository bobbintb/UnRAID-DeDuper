name: Pull and Edit

on:
  workflow_dispatch:
jobs:
  pull_and_edit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Package plugin as txz
        shell: bash
        run: |
          #!/bin/bash
          dest="./usr/local/emhttp/plugins/bobbintb.system.dedupe"
          mkdir -p "$dest"
          rsync -a --exclude=bundle.bat --exclude=bobbintb.system.dedupe.plg --exclude=deduper.db --exclude=query.txt --exclude=.gitignore --exclude="*.yml" --exclude=usr --exclude=.git --exclude=.vs ./src/ "$dest"
          tar cJf ./artifacts/bobbintb.system.dedupe.txz -C ./usr .
          rm -rf usr
      - name: Edit file with PowerShell
        shell: bash
        run: |
          #!/bin/bash
          file="./artifacts/bobbintb.system.dedupe.plg"
          md5Hash=$(md5sum "$file" | awk '{print $1}')
          pattern='ENTITY MD5\s+"([^"]+)"'
          content=$(<"$file")
          newContent=$(echo "$content" | sed -E "s/$pattern/ENTITY MD5       \"$md5Hash\"/")
          echo "$newContent" > "$file"
      - name: Git Commit and Push
          # You may pin to the exact commit or the version.
          # uses: github-actions-x/commit@722d56b8968bf00ced78407bbe2ead81062d8baa
        uses: actions-js/push@latest
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
